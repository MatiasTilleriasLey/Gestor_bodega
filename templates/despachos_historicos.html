{% extends 'base.html' %}
{% block title %}Histórico de despachos · Bodega{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Histórico de Despachos</h2>

  <!-- FILTROS -->
  <div class="row g-2 mb-3 align-items-end">
    <div class="col-auto">
      <label for="filterOperator" class="form-label">Operador</label>
      <input type="text" id="filterOperator" class="form-control" placeholder="Nombre de usuario">
    </div>
    <div class="col-auto">
      <label for="filterClient" class="form-label">Cliente</label>
      <input type="text" id="filterClient" class="form-control" placeholder="Nombre de cliente">
    </div>
    <div class="col-auto">
      <label for="filterStart" class="form-label">Desde</label>
      <input type="date" id="filterStart" class="form-control">
    </div>
    <div class="col-auto">
      <label for="filterEnd" class="form-label">Hasta</label>
      <input type="date" id="filterEnd" class="form-control">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" id="btnFilter">Filtrar</button>
      <button class="btn btn-secondary" id="btnClear">Limpiar</button>
    </div>
  </div>

  <table class="table table-hover" id="histDespTable">
    <thead>
      <tr>
        <th>Despacho #</th>
        <th>Cliente</th>
        <th>Operador</th>
        <th>Fecha / Hora</th>
        <th>Detalles</th>
        <th>Fotos</th>
        <th>Editar</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal de fotos -->
  <div class="modal fade" id="photosModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Fotos despacho <span id="photoModalBatch"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="photoForm" class="row g-2 align-items-center mb-3">
            <input type="hidden" id="photoBatchId">
            <div class="col-sm-4">
              <label class="form-label">Etapa</label>
              <select class="form-select" id="photoStage" required>
                <option value="salida">Salida</option>
                <option value="entrega">Entrega</option>
              </select>
            </div>
            <div class="col-sm-5">
              <label class="form-label">Imagen</label>
              <input type="file" class="form-control" id="photoFile" accept="image/*" required>
            </div>
            <div class="col-sm-3 d-grid">
              <label class="form-label invisible">Subir</label>
              <button class="btn btn-primary" type="submit">Subir foto</button>
            </div>
          </form>
          <div id="photosGrid" class="row g-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  // Inputs de filtro
  const opInput    = document.getElementById('filterOperator');
  const clInput    = document.getElementById('filterClient');
  const startInput = document.getElementById('filterStart');
  const endInput   = document.getElementById('filterEnd');

  // Almacena los datos traídos del backend
  let allBatches = [];

  // 1) Carga inicial de datos
  function loadHistoricoDespachos() {
    fetch('/api/despachos/historico')
      .then(res => res.json())
      .then(batches => {
        allBatches = batches;
        applyFilters();
      })
      .catch(console.error);
  }

  // 2) Aplica todos los filtros al array y re-renderiza
  function applyFilters() {
    const op    = opInput.value.trim().toLowerCase();
    const cl    = clInput.value.trim().toLowerCase();
    const start = startInput.value; // YYYY-MM-DD
    const end   = endInput.value;   // YYYY-MM-DD

    const filtered = allBatches.filter(b => {
      // filtro operador
      if (op && !b.user.toLowerCase().includes(op)) return false;
      // filtro cliente
      if (cl && !b.client.toLowerCase().includes(cl)) return false;
      // filtro fecha desde
      if (start) {
        const fecha = b.created_at.split(' ')[0].split('/').reverse().join('-');
        if (fecha < start) return false;
      }
      // filtro fecha hasta
      if (end) {
        const fecha = b.created_at.split(' ')[0].split('/').reverse().join('-');
        if (fecha > end) return false;
      }
      return true;
    });

    renderTable(filtered);
  }

  // 3) Renderiza la tabla dada la lista de batches
  function renderTable(batches) {
    const tbody = document.querySelector('#histDespTable tbody');
    tbody.innerHTML = '';

    batches.forEach(b => {
      // fila principal
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${b.batch_id}</td>
        <td>${b.client}</td>
        <td>${b.user}</td>
        <td>${b.created_at}</td>
        <td>
          <button class="btn btn-sm btn-outline-info"
                  onclick="toggleDetails(${b.batch_id}, this)">
            Ver ítems
          </button>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="openPhotos(${b.batch_id})">
            Evidencia
          </button>
        </td>
        <td>
          <a
            href="/despachos/editar/${b.batch_id}"
            class="btn btn-sm btn-warning"
          >
            <i class="bi bi-pencil-square"></i> Editar
          </a>
        </td>`;
      tbody.appendChild(tr);

      // fila de detalles oculta
      const det = document.createElement('tr');
      det.id = 'details-desp-' + b.batch_id;
      det.classList.add('d-none');
      det.innerHTML = `
        <td colspan="5">
          <ul class="list-group">
            ${b.items.map(i => `
              <li class="list-group-item">
                [${i.quantity}] ${i.product} — ${i.brand}
              </li>`).join('')}
          </ul>
        </td>`;
      tbody.appendChild(det);
    });
  }

  // 4) Toggle de detalles
  function toggleDetails(batchId, btn) {
    const det = document.getElementById('details-desp-' + batchId);
    det.classList.toggle('d-none');
    btn.textContent = det.classList.contains('d-none') ? 'Ver ítems' : 'Ocultar';
  }

  // 5) Event listeners de filtros
  opInput.addEventListener('input', applyFilters);
  clInput.addEventListener('input', applyFilters);
  startInput.addEventListener('change', applyFilters);
  endInput.addEventListener('change', applyFilters);

  // Inicializar al cargar página
  document.addEventListener('DOMContentLoaded', loadHistoricoDespachos);

  // --- Fotos de despacho ---
  let photosModal = null;
  function openPhotos(batchId) {
    document.getElementById('photoBatchId').value = batchId;
    document.getElementById('photoModalBatch').textContent = `#${batchId}`;
    document.getElementById('photoFile').value = '';
    loadPhotos(batchId);
    if (!photosModal) {
      photosModal = new bootstrap.Modal(document.getElementById('photosModal'));
    }
    photosModal.show();
  }

  function loadPhotos(batchId) {
    fetch(`/api/despachos/${batchId}/fotos`)
      .then(r => r.json())
      .then(list => {
        const grid = document.getElementById('photosGrid');
        grid.innerHTML = '';
        if (!Array.isArray(list) || !list.length) {
          grid.innerHTML = '<div class="text-muted">Sin fotos aún.</div>';
          return;
        }
        list.forEach(p => {
          const col = document.createElement('div');
          col.className = 'col-sm-6 col-md-4';
          col.innerHTML = `
            <div class="card">
              <div class="card-body p-2">
                <span class="badge text-bg-secondary mb-2 text-uppercase">${p.stage}</span>
                <img src="${p.url}" alt="foto" class="img-fluid rounded-3">
                <div class="text-muted small mt-1">${p.created_at || ''}</div>
              </div>
            </div>`;
          grid.appendChild(col);
        });
      });
  }

  document.getElementById('photoForm').addEventListener('submit', ev => {
    ev.preventDefault();
    const batchId = document.getElementById('photoBatchId').value;
    const stage = document.getElementById('photoStage').value;
    const file = document.getElementById('photoFile').files[0];
    if (!file) return;
    const fd = new FormData();
    fd.append('stage', stage);
    fd.append('photo', file);
    fetch(`/api/despachos/${batchId}/fotos`, {
      method: 'POST',
      body: fd
    })
      .then(r => r.json().then(body => ({ status: r.status, body })))
      .then(({ status, body }) => {
        if (status >= 200 && status < 300) {
          loadPhotos(batchId);
        } else {
          alert(body.error || 'No se pudo subir la foto');
        }
      })
      .catch(() => alert('Error de red al subir la foto'));
  });
</script>
{% endblock %}
