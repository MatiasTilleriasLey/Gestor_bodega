{% extends 'base.html' %}
{% block title %}Orden {{ order.number }} · Bodega{% endblock %}
{% block content %}
<div class="container mt-4" style="max-width:700px;">
  <h2>Orden {{ order.number }}</h2>
  <p>
    <strong>Cliente:</strong> {{ order.client.name }}<br>
    <strong>Fecha:</strong> {{ order.created_at.strftime('%d/%m/%Y %H:%M') }}
  </p>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Solicitado</th>
        <th>Despachado</th>
        <th>Pendiente</th>
      </tr>
    </thead>
    <tbody>
      {% for line in detail %}
      <tr>
        <td>{{ line.product }}</td>
        <td>{{ line.solicitado }}</td>
        <td>{{ line.despachado }}</td>
        <td>
          {% if line.pendiente > 0 %}
            <span class="text-danger">{{ line.pendiente }}</span>
          {% else %}
            <span class="text-success">0</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="btn-group mt-3">
    <a
      href="{{ url_for('ordenes_editar', order_id=order.id) }}"
      class="btn btn-warning"
    >
      <i class="bi bi-pencil-square"></i> Editar Orden
    </a>

    <a
      href="{{ url_for('nuevos_despachos') }}?client={{ order.client.name | urlencode }}&order_number={{ order.number | urlencode }}"
      class="btn btn-primary"
    >
      <i class="bi bi-truck"></i> Crear Despacho
    </a>

    <a
      href="{{ url_for('ordenes_listado') }}"
      class="btn btn-secondary"
    >
      Volver
    </a>
  </div>
  <hr class="my-4">

<h3>Despachos asociados</h3>
{% if dispatch_history %}
  {% for d in dispatch_history %}
    <div class="card mb-3 bg-dark text-white">
      <div class="card-header">
        Despacho #{{ d.batch_id }} por {{ d.user }}
        <span class="float-end">
          {{ d.created.strftime('%d/%m/%Y %H:%M') }}
          <button class="btn btn-sm btn-outline-info ms-2" onclick="openPhotos({{ d.batch_id }})">Fotos</button>
        </span>
      </div>
      <ul class="list-group list-group-flush bg-white text-dark">
        {% for it in d['items'] %}
        <li class="list-group-item">
          [{{ it.qty }}] {{ it.product }} — {{ it.brand }}
        </li>
        {% endfor %}
      </ul>
    </div>
  {% endfor %}
{% else %}
  <p class="text-muted">Aún no se han realizado despachos para esta orden.</p>
{% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  let photosModal = null;
  let currentBatchId = null;

  function ensureModal() {
    if (document.getElementById('photosModal')) return;
    const modalHtml = `
    <div class="modal fade" id="photosModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Fotos despacho <span id="photoModalBatch"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="photoForm" class="row g-2 align-items-center mb-3">
              <input type="hidden" id="photoBatchId">
              <div class="col-sm-4">
                <label class="form-label">Etapa</label>
                <select class="form-select" id="photoStage" required>
                  <option value="salida">Salida</option>
                  <option value="entrega">Entrega</option>
                </select>
              </div>
              <div class="col-sm-5">
                <label class="form-label">Imagen</label>
                <input type="file" class="form-control" id="photoFile" accept="image/*" required>
              </div>
              <div class="col-sm-3 d-grid">
                <label class="form-label invisible">Subir</label>
                <button class="btn btn-primary" type="submit">Subir foto</button>
              </div>
            </form>
            <div id="photosGrid" class="row g-2"></div>
          </div>
        </div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }

  function openPhotos(batchId) {
    ensureModal();
    currentBatchId = batchId;
    document.getElementById('photoBatchId').value = batchId;
    document.getElementById('photoModalBatch').textContent = `#${batchId}`;
    document.getElementById('photoFile').value = '';
    loadPhotos(batchId);
    if (!photosModal) {
      photosModal = new bootstrap.Modal(document.getElementById('photosModal'));
      document.getElementById('photoForm').addEventListener('submit', uploadPhoto);
    }
    photosModal.show();
  }

  function loadPhotos(batchId) {
    fetch(`/api/despachos/${batchId}/fotos`)
      .then(r => r.json())
      .then(list => {
        const grid = document.getElementById('photosGrid');
        grid.innerHTML = '';
        if (!Array.isArray(list) || !list.length) {
          grid.innerHTML = '<div class="text-muted">Sin fotos aún.</div>';
          return;
        }
        list.forEach(p => {
          const col = document.createElement('div');
          col.className = 'col-sm-6 col-md-4';
          col.innerHTML = `
            <div class="card">
              <div class="card-body p-2">
                <span class="badge text-bg-secondary mb-2 text-uppercase">${p.stage}</span>
                <img src="${p.url}" alt="foto" class="img-fluid rounded-3">
                <div class="text-muted small mt-1">${p.created_at || ''}</div>
              </div>
            </div>`;
          grid.appendChild(col);
        });
      });
  }

  function uploadPhoto(ev) {
    ev.preventDefault();
    const batchId = document.getElementById('photoBatchId').value;
    const stage = document.getElementById('photoStage').value;
    const file = document.getElementById('photoFile').files[0];
    if (!file) return;
    const fd = new FormData();
    fd.append('stage', stage);
    fd.append('photo', file);
    fetch(`/api/despachos/${batchId}/fotos`, {
      method: 'POST',
      body: fd
    })
      .then(r => r.json().then(body => ({ status: r.status, body })))
      .then(({ status, body }) => {
        if (status >= 200 && status < 300) {
          loadPhotos(batchId);
        } else {
          alert(body.error || 'No se pudo subir la foto');
        }
      })
      .catch(() => alert('Error de red al subir la foto'));
  }
</script>
{% endblock %}
